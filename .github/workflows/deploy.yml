name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: admin
          key: ${{ secrets.AWS_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/admin/database-lab4/lab4_for_bd

            # ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ¾Ğ´Ñƒ
            git fetch origin
            git checkout main
            git pull origin main

            # ĞĞºÑ‚Ğ¸Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ°Ğ±Ğ¾ ÑÑ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ²Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğµ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğµ
            python3 -m venv venv || true
            source venv/bin/activate

            # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹
            pip install --upgrade pip
            pip install -r app/requirements.txt

            # Ğ—Ğ¼Ñ–Ğ½Ğ½Ñ– ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°
            export USE_MYSQL=true

            # ĞĞµ Ğ²Ğ¸Ñ…Ğ¾Ğ´Ğ¸Ñ‚Ğ¸ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»ĞºĞ°Ñ… Ğ¿Ñ–Ğ´ Ñ‡Ğ°Ñ Ğ¾Ñ‡Ğ¸Ñ‰ĞµĞ½Ğ½Ñ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ²
            set +e
            
            # ğŸ” Ğ—ÑƒĞ¿Ğ¸Ğ½ĞºĞ° ÑÑ‚Ğ°Ñ€Ğ¸Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ–Ğ² - ĞĞ“Ğ Ğ•Ğ¡Ğ˜Ğ’ĞĞ˜Ğ™ ĞœĞ•Ğ¢ĞĞ”
            echo "ğŸ” Stopping ALL old Flask/Waitress/Python processes..."

            # ĞœĞµÑ‚Ğ¾Ğ´ 1: Ğ’Ğ±Ğ¸Ñ‚Ğ¸ Ğ²ÑÑ– Python Ğ¿Ñ€Ğ¾Ñ†ĞµÑĞ¸ Ğ· run_production.py
            echo "Method 1: Killing run_production.py processes..."
            pkill -9 -f "run_production.py" 2>/dev/null || echo "No run_production.py processes found"
            pkill -9 -f "python.*run_production" 2>/dev/null || echo "No python run_production processes found"

            # ĞœĞµÑ‚Ğ¾Ğ´ 2: Ğ’Ğ±Ğ¸Ñ‚Ğ¸ Ğ²ÑÑ– waitress Ğ¿Ñ€Ğ¾Ñ†ĞµÑĞ¸
            echo "Method 2: Killing waitress processes..."
            pkill -9 -f "waitress" 2>/dev/null || echo "No waitress processes found"

            # ĞœĞµÑ‚Ğ¾Ğ´ 3: Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ PID Ñ„Ğ°Ğ¹Ğ»
            echo "Method 3: Removing PID file..."
            rm -f app.pid

            # ĞœĞµÑ‚Ğ¾Ğ´ 4: Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ°Ñ‚Ğ¸ fuser (ÑĞºÑ‰Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¸Ğ¹)
            echo "Method 4: Using fuser to kill port 5000..."
            fuser -k 5000/tcp 2>/dev/null || echo "No process on port 5000 (via fuser)"

            # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ Ğ¿Ğ¾Ñ€Ñ‚ Ğ·Ğ²Ñ–Ğ»ÑŒĞ½Ğ¸Ñ‚ÑŒÑÑ
            echo "Waiting for port 5000 to be free..."
            sleep 5

            # ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾ Ñ‡Ğ¸ Ğ¿Ğ¾Ñ€Ñ‚ Ğ²Ñ–Ğ»ÑŒĞ½Ğ¸Ğ¹
            if netstat -tuln 2>/dev/null | grep -q ':5000 '; then
              echo "âš ï¸  Port 5000 still in use, trying one more time..."
              fuser -k -9 5000/tcp 2>/dev/null || echo "Force kill attempted"
              sleep 3
            else
              echo "âœ… Port 5000 is free"
            fi
            
            # ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ÑÑŒ Ğ´Ğ¾ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñƒ "Ğ²Ğ¸Ñ…Ñ–Ğ´ Ğ¿Ñ€Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¸Ğ»Ñ†Ñ–"
            set -e

            # ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑĞµÑ€Ğ²ĞµÑ€Ğ° Ñƒ Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¼Ñƒ Ñ€ĞµĞ¶Ğ¸Ğ¼Ñ–
            echo "ğŸš€ Starting new Flask/Waitress application..."
            nohup python3 run_production.py > flask.log 2>&1 & echo $! > app.pid
            NEW_PID=$(cat app.pid)
            echo "Started new process with PID: $NEW_PID"

            # ĞÑ‡Ñ–ĞºÑƒÑ”Ğ¼Ğ¾, Ğ¿Ğ¾ĞºĞ¸ ÑĞµÑ€Ğ²ĞµÑ€ ÑÑ‚Ğ°Ñ€Ñ‚ÑƒÑ”
            sleep 8
            if kill -0 $NEW_PID 2>/dev/null; then
              echo "âœ… Flask/Waitress is running (PID $NEW_PID)"
              curl -s http://localhost:5000/health || true
            else
              echo "âŒ Flask/Waitress failed to start"
              tail -50 flask.log || true
              exit 1
            fi

      - name: Health Check
        run: |
          sleep 5
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.AWS_EC2_HOST }}:5000/health)
          if [ $response -eq 200 ]; then
            echo "âœ… Application is running successfully!"
            echo "ğŸŒ API Endpoint: http://${{ secrets.AWS_EC2_HOST }}:5000/candidates"
            echo "ğŸ“š Swagger UI: http://${{ secrets.AWS_EC2_HOST }}:5000/apidocs/"
          else
            echo "âŒ Health check failed with status code: $response"
            tail -50 /home/admin/database-lab4/lab4_for_bd/flask.log || true
            exit 1
          fi

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸ‰ Application deployed to production"
          echo "ğŸ“ Swagger documentation: http://${{ secrets.AWS_EC2_HOST }}:5000/apidocs/"

      - name: Notify on failure
        if: failure()
        run: echo "âŒ Deployment failed! Check logs for details"
