name: Deploy to AWS EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.AWS_EC2_HOST }}
          username: admin
          key: ${{ secrets.AWS_PRIVATE_KEY }}
          port: 22
          script: |
            cd /home/admin/database-lab4/lab4_for_bd

            # ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ ĞºĞ¾Ğ´Ñƒ
            git fetch origin
            git checkout main
            git pull origin main

            # ĞĞºÑ‚Ğ¸Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ°Ğ±Ğ¾ ÑÑ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ²Ñ–Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğµ ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğµ
            python3 -m venv venv || true
            source venv/bin/activate

            # Ğ’ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ½Ñ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ÑÑ‚ĞµĞ¹
            pip install --upgrade pip
            pip install -r app/requirements.txt

            # Ğ—Ğ¼Ñ–Ğ½Ğ½Ñ– ÑĞµÑ€ĞµĞ´Ğ¾Ğ²Ğ¸Ñ‰Ğ°
            export USE_MYSQL=true

            # Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ ÑĞºĞ¸Ğ¹ Ğ²Ğ¸ĞºĞ¾Ğ½Ğ°Ñ”Ñ‚ÑŒÑÑ ĞŸĞ†Ğ¡Ğ›Ğ¯ Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ñ‚Ñ SSH
            cat > restart_after_ssh.sh << 'EOF'
            #!/bin/bash
            sleep 2
            cd /home/admin/database-lab4/lab4_for_bd
            
            # Ğ’Ğ±Ğ¸Ğ²Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ°Ñ€Ñ– Ğ¿Ñ€Ğ¾Ñ†ĞµÑĞ¸
            pkill -9 -f "run_production.py" || true
            pkill -9 -f "waitress" || true
            fuser -k -9 5000/tcp || true
            rm -f app.pid
            
            # Ğ§ĞµĞºĞ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾ĞºĞ¸ Ğ¿Ğ¾Ñ€Ñ‚ Ğ·Ğ²Ñ–Ğ»ÑŒĞ½Ğ¸Ñ‚ÑŒÑÑ
            sleep 3
            
            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€
            source venv/bin/activate
            export USE_MYSQL=true
            nohup python3 run_production.py > flask.log 2>&1 & echo $! > app.pid
            EOF
            
            chmod +x restart_after_ssh.sh
            
            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾ ÑĞºÑ€Ğ¸Ğ¿Ñ‚ ĞŸĞ†Ğ¡Ğ›Ğ¯ Ğ²Ğ¸Ñ…Ğ¾Ğ´Ñƒ Ğ· SSH Ñ‡ĞµÑ€ĞµĞ· at
            echo "bash /home/admin/database-lab4/lab4_for_bd/restart_after_ssh.sh" | at now + 1 minute 2>/dev/null || {
              # Ğ¯ĞºÑ‰Ğ¾ at Ğ½Ğµ Ğ¿Ñ€Ğ°Ñ†ÑÑ”, Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ screen
              screen -dmS deploy_restart bash restart_after_ssh.sh || {
                # Ğ¯ĞºÑ‰Ğ¾ screen Ğ½Ğµ Ğ¿Ñ€Ğ°Ñ†ÑÑ”, Ğ²Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ nohup Ğ· disown
                (nohup bash restart_after_ssh.sh > /dev/null 2>&1 &) && disown
              }
            }
            
            echo "âœ… Deployment script scheduled to run after SSH disconnect"
            echo "â³ Server will restart in ~1 minute"

      - name: Health Check
        run: |
          echo "â³ Waiting for server to restart (75 seconds)..."
          sleep 75
          
          echo "ğŸ” Checking if server is up..."
          response=$(curl -s -o /dev/null -w "%{http_code}" http://${{ secrets.AWS_EC2_HOST }}:5000/health)
          if [ $response -eq 200 ]; then
            echo "âœ… Application is running successfully!"
            echo "ğŸŒ API Endpoint: http://${{ secrets.AWS_EC2_HOST }}:5000/candidates"
            echo "ğŸ“š Swagger UI: http://${{ secrets.AWS_EC2_HOST }}:5000/apidocs/"
          else
            echo "âš ï¸  Health check returned status code: $response"
            echo "Server might still be starting up, this is OK for CD"
            echo "ğŸŒ Check manually: http://${{ secrets.AWS_EC2_HOST }}:5000/apidocs/"
          fi

      - name: Notify on success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸ‰ Application deployed to production"
          echo "ğŸ“ Swagger documentation: http://${{ secrets.AWS_EC2_HOST }}:5000/apidocs/"

      - name: Notify on failure
        if: failure()
        run: echo "âŒ Deployment failed! Check logs for details"
